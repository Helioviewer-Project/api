name: Build and Test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Get development docker compose file
      run: cd .. && wget https://raw.githubusercontent.com/Helioviewer-Project/helioviewer.org-docker/main/compose.yaml

    # The containers need to be able update config files
    - name: Make writeable config files
      run: |
        touch install/settings/settings.cfg
        chmod o+rw install/settings/settings.cfg
        touch settings/Config.ini
        chmod o+rw settings/Config.ini
        touch settings/Config.php
        chmod o+rw settings/Config.php

    # Start up api service
    # Start up cli service (installs test data)
    - name: Start services
      run: cd .. && docker compose up --no-build -d api cli

    - name: Wait for containers to be ready
      # Wait for the cli container to get the data used in unit tests
      # This will wait up to 2 minutes
      run: bash .github/workflows/wait_for_ready.sh

    # Run the tests inside the api container
    - name: Run phpunit tests
      run: docker exec -t helioviewer-api-1 composer run-script test

    - name: Run python tests
      run: docker exec -t helioviewer-api-1 composer run-script test-python
