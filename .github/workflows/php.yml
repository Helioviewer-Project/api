name: Build and Test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Get development docker compose file
      run: |
        cd ..
        wget https://raw.githubusercontent.com/Helioviewer-Project/helioviewer.org-docker/main/compose.yaml
        wget https://raw.githubusercontent.com/Helioviewer-Project/helioviewer.org-docker/main/.env.example
        mv .env.example .env

    # The containers need to be able update config files
    - name: Make writeable config files
      run: |
        touch install/settings/settings.cfg
        chmod o+rw install/settings/settings.cfg
        touch settings/Config.ini
        chmod o+rw settings/Config.ini
        touch settings/Config.php
        chmod o+rw settings/Config.php

    # Start up api service (test environment)
    - name: Start services
      # --no-build to force it to use whatever is published in the registry
      # -d to detach, so the command returns
      # --wait to wait for containers to be healthy, meaning the test data is downloaded and ready
      run: cd .. && docker compose up --no-build --wait api

    - name: Print container logs logs
      if: always()
      run: docker logs helioviewer-api-1

    - name: Print container logs logs
      if: always()
      run: |
        docker logs helioviewer-api-1
        docker logs helioviewer-web-1
        docker logs helioviewer-cli-1
        docker logs helioviewer-movies-1

    # Run the tests inside the api container
    - name: Run phpunit tests
      run: docker exec -t helioviewer-api-1 composer run-script test

    - name: Run python tests
      run: docker exec -t helioviewer-api-1 composer run-script test-python
