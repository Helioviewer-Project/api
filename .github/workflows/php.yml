name: Build and Test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Get development docker compose file
      run: cd .. && wget https://raw.githubusercontent.com/Helioviewer-Project/helioviewer.org-docker/dev/compose.yaml

    # Start up api service
    # Start up cli service (installs test data)
    - name: Start services
      run: cd .. && docker compose up --no-build -d api cli

    - name: Wait for test data to be ready
      # Loop checking for the SOHO data used in unit tests
      # if ls returns 0, the directory exists and tests can proceed.
      # The loop below waits up to 2 minutes.
      run: |
        for i in {1..12}; do
          docker exec -t helioviewer-cli-1 ls /tmp/jp2/LASCO-C2/2023/12/01/white-light/
          if [ $? -eq 0 ]; then
            exit 0
          fi
          sleep 10
        done
        exit 1

    # Run the tests inside the api container
    - name: Run tests
      run: docker exec -t helioviewer-api-1 composer run-script test

    # - name: Cache Composer packages
    #   id: composer-cache
    #   uses: actions/cache@v3
    #   with:
    #     path: vendor
    #     key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
    #     restore-keys: |
    #       ${{ runner.os }}-php

    # - name: Set up test environment
    #   run: |
    #     mkdir log
    #     mkdir cache
    #     ln -s $PWD /home/helioviewer/api.helioviewer.org
    #     ln -s /tmp/jp2 docroot/jp2
    #     composer run-script make-test-config

    # - name: Install dependencies
    #   run: composer install --prefer-dist --no-progress

    # - name: Install python packages for root user
    #   run: |
    #     su helioviewer -c "python3 -m pip freeze > /tmp/helioviewer-packages"
    #     python3 -m pip install -r /tmp/helioviewer-packages

    # - name: Startup background services
    #   run: |
    #     httpd
    #     mysqld --user=mysql -D
    #     redis-server --daemonize yes
    #     tcsh scripts/movie_queue.tcsh
    #     ./vendor/bin/start_hgs2hpc

    # - name: Re-install Helioviewer Database for current branch
    #   run: |
    #     mysql -e "drop database helioviewer; drop user 'helioviewer'@'localhost';"
    #     cd management/data && ./setup_db.exp

    # - name: Run PHP test suite
    #   run: composer run-script test

    # - name: Run Python test suite
    #   run: composer run-script test-python
